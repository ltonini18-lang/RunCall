<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Finaliser la réservation – RunCall</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="support.css">
</head>

<body>

<header class="site-header">
  <div class="container header-inner">
    <a href="/" class="logo-link">
      <div class="logo">RunCall</div>
    </a>
  </div>
</header>

<div class="lang-switch">
  <button type="button" data-lang="fr">FR</button>
  <button type="button" data-lang="en">EN</button>
</div>

<section class="section support-page">
  <div class="container checkout-wrap">

    <div class="checkout-card">

      <div class="checkout-hero">
        <div class="badge">
          <span class="badge-dot"></span>
          <span data-fr="Étape finale" data-en="Final step"></span>
        </div>

        <h1 class="checkout-title"
            data-fr="Finaliser la réservation"
            data-en="Finalize your booking"></h1>
      </div>

      <div class="checkout-body">
        <p class="support-note" id="introText"
           data-fr="Toutes les options donnent accès à la même conversation. Tu choisis simplement à quel montant tu souhaites soutenir l’intervenant."
           data-en="All options give access to the same conversation. You’re simply choosing how much you want to support the person.">
        </p>

        <div class="support-grid" id="pricingGrid">
            <div style="grid-column: 1/-1; text-align: center; color: #94a3b8;">Loading...</div>
        </div>

        <div class="checkout-footer">
          <div class="secure">
            <div class="lock">✓</div>
            <span data-fr="Paiement sécurisé" data-en="Secure payment"></span>
          </div>
        </div>
      </div>

    </div>

  </div>
</section>

<script>
// 1. Langue
(function () {
  const buttons = document.querySelectorAll('.lang-switch button');
  let lang = localStorage.getItem('runcall_lang');
  if (!lang) {
    const browserLang = navigator.language || navigator.userLanguage;
    lang = browserLang.toLowerCase().startsWith('fr') ? 'fr' : 'en';
  }
  function applyLanguage(nextLang) {
    lang = nextLang;
    document.querySelectorAll('[data-fr][data-en]').forEach(el => {
      el.textContent = el.dataset[lang];
    });
    buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
    localStorage.setItem('runcall_lang', lang);
  }
  buttons.forEach(btn => btn.addEventListener('click', () => applyLanguage(btn.dataset.lang)));
  applyLanguage(lang);
})();

// 2. Logique Prix & Paiement
(async function () {
  const params = new URLSearchParams(window.location.search);
  const bookingId = params.get("booking_id");
  const grid = document.getElementById('pricingGrid');
  const intro = document.getElementById('introText');
  const lang = localStorage.getItem('runcall_lang') || 'fr';

  const symbols = { 'usd': '$', 'eur': '€', 'gbp': '£', 'cad': 'CA$' };

  if (!bookingId) {
      grid.innerHTML = `<div style="color:red;">Error: Booking ID missing.</div>`;
      return;
  }

  // A. Fonction de paiement
  async function goToStripe(priceTier = null) {
      // Bloquer l'interface
      const allBtns = document.querySelectorAll('button');
      allBtns.forEach(b => { b.disabled = true; b.style.opacity = '0.7'; b.textContent = '...'; });

      try {
          const res = await fetch("/api/stripe/create-checkout-session", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ booking_id: bookingId, price_tier: priceTier ? Number(priceTier) : null })
          });
          const json = await res.json();
          
          if (!res.ok) throw new Error(json.error || "Erreur Stripe");
          
          window.location.href = json.checkout_url;
      } catch (err) {
          alert("Error: " + err.message);
          window.location.reload();
      }
  }

  // B. Récupération de la config Expert
  try {
      const res = await fetch(`/api/bookings/get-info?booking_id=${bookingId}`);
      const info = await res.json();
      
      const symbol = symbols[info.currency] || '$';
      grid.innerHTML = ''; // Clear loading

      if (info.hasFixedPrice) {
          // --- CAS 1 : PRIX FIXE ---
          intro.innerHTML = lang === 'fr' 
              ? "Cet expert applique un tarif fixe pour la consultation." 
              : "This expert has a fixed rate for the consultation.";
          
          // Style : Une seule colonne
          grid.style.gridTemplateColumns = "1fr";
          
          const btn = document.createElement('button');
          btn.className = "support-btn featured";
          btn.style.maxWidth = "320px";
          btn.style.margin = "0 auto";
          btn.innerHTML = `
            <span class="price">${info.fixedPrice}${symbol}</span>
            <div style="font-size:0.85em; margin-top:4px; font-weight:normal; opacity:0.9;">
                ${lang === 'fr' ? 'Valider la réservation' : 'Confirm booking'}
            </div>
          `;
          btn.onclick = () => goToStripe(null);
          grid.appendChild(btn);

      } else {
          // --- CAS 2 : PALIERS (29/49/79) ---
          // On garde le texte d'intro par défaut (déjà dans le HTML)
          
          const tiers = [29, 49, 79];
          tiers.forEach((tier, index) => {
              const btn = document.createElement('button');
              btn.className = index === 1 ? "support-btn featured" : "support-btn"; // Le milieu est "featured"
              btn.innerHTML = `<span class="price">${tier}${symbol}</span>`;
              btn.onclick = () => goToStripe(tier);
              grid.appendChild(btn);
          });
      }

  } catch (err) {
      console.error(err);
      grid.innerHTML = `<div style="color:red">Erreur de chargement. <a href="#" onclick="window.location.reload()">Réessayer</a></div>`;
  }

})();
</script>

</body>
</html>
