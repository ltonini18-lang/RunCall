<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>RunCall – Disponibilités</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* =========================
       Unicorn Calendly-style Page (scoped)
       ========================= */

    :root{
      --rc-bg: #f8fafc;
      --rc-card: #ffffff;
      --rc-border: #e5e7eb;
      --rc-text: #0f172a;
      --rc-muted: #64748b;
      --rc-blue: #1677ff;

      /* “Licorne” blue gradient (same vibe as avatar fallback) */
      --rc-blue-grad:
        radial-gradient(140px 110px at 30% 20%, rgba(22,119,255,.30), transparent 58%),
        radial-gradient(140px 110px at 80% 60%, rgba(22,119,255,.20), transparent 58%),
        #ffffff;

      --rc-shadow: 0 18px 40px rgba(15,23,42,.08);
    }

    .p-page{ background: var(--rc-bg); }

    /* ✅ CHANGED: reduce top “grey” space */
    .p-wrap{ max-width: 848px; margin: 0 auto; padding: 8px 0 52px; }

    .p-card{
      background:var(--rc-card);
      border:1px solid var(--rc-border);
      border-radius:20px;
      box-shadow:var(--rc-shadow);
      overflow:hidden;
    }

    /* ✅ Header tagline next to logo (premium typography + single-line on mobile) */
    /* ✅ Header tagline next to logo (handwritten/calligraphy vibe + tighter spacing) */
.site-header .header-inner{
  display:flex;
  align-items:baseline;     /* feels more “logo + signature” */
  gap:6px;                 /* ✅ less space between logo and phrase */
}

/* in case style.css adds spacing somewhere */
.site-header .logo-link{ display:inline-flex; align-items:baseline; }
.site-header .logo{ line-height: 1; }

.rc-tagline{
  /* ✅ Premium SaaS / "licorne" typography, very readable */
  font-family: ui-sans-serif, system-ui, -apple-system,
               "SF Pro Display", "SF Pro Text",
               Inter, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

  font-style: italic;
  font-weight: 650;
  font-size: 1.02rem;              /* desktop size */
  color: rgba(15,23,42,.72);          /* darker, readable */

  letter-spacing: -.02em;
  line-height: 1;

  white-space: nowrap;
  margin-left: 2px;                   /* glued to logo */
  transform: translateY(1px);
  text-shadow: 0 1px 0 rgba(255,255,255,.35);
}


@media (max-width: 640px){
  .site-header .header-inner{
    flex-direction: row;                 /* ✅ reste en ligne */
    align-items: baseline;
    justify-content: flex-start !important;
    gap: 6px;
  }

  /* Empêche le logo de casser la ligne */
  .site-header .logo-link{ flex: 0 0 auto; }
  .site-header .logo{ white-space: nowrap; }

  /* La phrase reste collée, et s’adapte en taille pour rentrer */
 .rc-tagline{
  flex: 1 1 auto;
  min-width: 0;
  margin-left: 0;
  white-space: nowrap;

  /* ✅ smaller so it fits (no missing letters) */
  font-size: clamp(0.64rem, 2.2vw, 0.86rem);

  /* ✅ fix cut descenders (g, q, y, p) */
  line-height: 1.18;
  padding-bottom: 2px;
  transform: none;

  overflow: hidden;
  text-overflow: clip; /* ✅ don't hide extra letters behind ellipsis */
}

}


    .p-hero{
      padding: 22px 24px 18px;
      border-bottom:1px solid var(--rc-border);
      background:
        radial-gradient(1000px 360px at 20% 0%, rgba(22,119,255,.14), transparent 60%),
        radial-gradient(900px 320px at 80% 20%, rgba(22,119,255,.10), transparent 55%);
      display:flex;
      gap:16px;
      align-items:flex-start; /* ✅ keep avatar top-left on web */
    }

    /* Avatar */
    .p-avatar{
      width:78px; height:78px;
      border-radius:22px;
      border:1px solid var(--rc-border);
      background:#fff;
      overflow:hidden;
      flex:0 0 auto;
      display:grid;
      place-items:center;
      position:relative;
      margin-top: 2px;
    }
    .p-avatar img{
      width:100%; height:100%;
      object-fit:cover;
      display:none;
    }
    .p-avatar-fallback{
      width:100%; height:100%;
      display:grid;
      place-items:center;
      background: var(--rc-blue-grad);
      color: var(--rc-blue);
      font-weight: 900;
      letter-spacing: -.02em;
      font-size: 1.4rem;
    }

    .p-hero-main{ min-width:0; }
    .p-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--rc-border);
      background:#fff;
      color:#334155;
      font-size:.92rem;
    }
    .p-dot{
      width:8px; height:8px;
      border-radius:999px;
      background: var(--rc-blue);
      box-shadow: 0 0 0 4px rgba(22,119,255,.10);
    }
    .p-title{
      margin: 10px 0 6px;
      font-size: 1.65rem;
      line-height:1.2;
      letter-spacing:-.03em;
      color:var(--rc-text);
    }
    .p-subtitle{
      margin:0;
      color:#475569;
      line-height:1.6;
      font-size:1.0rem;
      max-width: 80ch;
    }

    .p-body{ padding: 14px 24px 24px; } /* ✅ slightly tighter */

    /* =========================
       Calendar area
       ========================= */

    .p-book-head{
      margin: 0 0 10px;
      text-align:center;
      font-weight: 950;
      letter-spacing:-.03em;
      color: var(--rc-text);
      font-size: 1.15rem;
    }

    .p-grid{
      display:flex;
      align-items:stretch;
      gap:16px;
      margin-top: 14px;
      min-width: 0;
      justify-content:center;
    }
    .p-grid.has-day{
      justify-content:space-between;
    }

    .p-panel{
      border:1px solid var(--rc-border);
      border-radius:18px;
      padding:16px;
      background:#fff;
      min-width:0;
    }

    .p-panel.calendar{
      flex: 0 0 50%;
      max-width: 460px;
      min-width: 320px;
    }

    .p-panel.slots{
      flex: 0 0 50%;
      max-width: 460px;
      min-width: 320px;

      opacity: 0;
      transform: translateX(10px);
      pointer-events: none;
      max-width: 0;
      min-width: 0;
      padding: 0;
      border-color: transparent;
      background: transparent;
      overflow: hidden;

      transition: opacity 220ms ease, transform 220ms ease, max-width 220ms ease, min-width 220ms ease, padding 220ms ease, border-color 220ms ease, background-color 220ms ease;
    }
    .p-grid.has-day .p-panel.slots{
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;

      max-width: 460px;
      min-width: 320px;
      padding:16px;
      border-color: var(--rc-border);
      background:#fff;
    }

    .p-month-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    .p-month-title{
      font-weight:900;
      color: var(--rc-text);
      letter-spacing:-.02em;
      font-size: 1.05rem;
      white-space:nowrap;
      text-align:center;
      flex: 1 1 auto;
    }

    .p-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--rc-border);
      background:#fff;
      color:var(--rc-text);
      cursor:pointer;
      transition: transform 140ms ease, border-color 160ms ease, background-color 160ms ease;
      user-select:none;
      font-weight:800;
      letter-spacing:-.01em;
      white-space:nowrap;
    }
    .p-btn:hover{
      transform: translateY(-1px);
      border-color: var(--rc-blue);
      background: rgba(22,119,255,.06);
    }

    .p-dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-bottom: 8px;
    }
    .p-dow div{
      text-align:center;
      font-size:.78rem;
      font-weight:900;
      color:#94a3b8;
      letter-spacing:.02em;
      text-transform: uppercase;
    }

    .p-month{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      user-select:none;
    }

    .p-mday{
      border-radius: 18px;
      padding: 12px 8px;
      min-height: 52px;

      display:flex;
      align-items:center;
      justify-content:center;

      font-weight: 950;
      letter-spacing: -.01em;

      transition: transform 140ms ease, background-color 160ms ease, box-shadow 180ms ease;
      cursor:pointer;
      background:#fff;
    }
    .p-mday:hover{ transform: translateY(-1px); }

    .p-mday.is-out{
      background: transparent;
      cursor: default;
    }
    .p-mday.is-out:hover{
      transform:none;
      background: transparent;
      box-shadow:none;
    }

    .p-mday.no-any{
      border: none;
      color: #9aa6b2;
      background: transparent;
    }
    .p-mday.no-any:hover{
      transform:none;
      background: transparent;
      box-shadow:none;
    }

    .p-mday.has-any{
      border: none;
      border-radius: 999px;
      background: rgba(22,119,255,.18);
      color: var(--rc-blue);
      box-shadow: none;
    }
    .p-mday.has-any:hover{
      background: rgba(22,119,255,.24);
      box-shadow: none;
    }

    .p-mday.is-selected{
      border: none;
      border-radius: 999px;
      background: rgba(22,119,255,.30);
      box-shadow: none;
    }

    .p-slots-date{
      text-align:center;
      font-weight: 950;
      letter-spacing:-.02em;
      color: var(--rc-text);
      font-size: 1.05rem;
      margin: 4px 0 12px;
    }
    .p-slot-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 6px;
    }

    .p-slot{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(22,119,255,.35);
      background:#fff;
      cursor:pointer;
      transition: transform 120ms ease, border-color 160ms ease, background-color 160ms ease, box-shadow 160ms ease;
      font-weight:950;
      color: var(--rc-blue);
      text-decoration:none;
      user-select:none;
      letter-spacing:-.01em;
    }
    .p-slot:hover{
      transform: translateY(-1px);
      border-color: rgba(22,119,255,.65);
      background: rgba(22,119,255,.06);
      box-shadow: 0 12px 24px rgba(22,119,255,.12);
    }

    .p-error{
      display:none;
      margin-top: 10px;
      border-radius: 14px;
      border:1px solid #fecaca;
      background:#fff1f2;
      padding: 12px;
      color:#881337;
      font-size:.95rem;
      line-height:1.55;
    }

    /* Modal */
    .p-modal-backdrop{
      position: fixed; inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .p-modal{
      width: 100%;
      max-width: 520px;
      background:#fff;
      border:1px solid var(--rc-border);
      border-radius: 18px;
      box-shadow:0 18px 50px rgba(15,23,42,.20);
      overflow:hidden;
    }
    .p-modal-head{
      padding:16px;
      border-bottom:1px solid var(--rc-border);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .p-modal-title{ font-weight:900; color:var(--rc-text); letter-spacing:-.02em; }
    .p-modal-body{ padding:16px; }
    .p-form-row{ margin: 0 0 12px; }
    .p-form-row label{ display:block; font-weight:900; color:var(--rc-text); margin-bottom:6px; }
    .p-form-row input, .p-form-row textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--rc-border);
      outline:none;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }
    .p-form-row input:focus, .p-form-row textarea:focus{
      border-color:var(--rc-blue);
      box-shadow: 0 0 0 4px rgba(22,119,255,.10);
    }
    .p-modal-actions{ display:flex; gap:10px; margin-top: 8px; }

    @media (max-width: 980px){
      .p-wrap{ max-width: 92vw; }
      .p-grid{ flex-direction: column; justify-content:flex-start; }
      .p-panel.calendar, .p-panel.slots{
        flex: 1 1 auto;
        width: 100%;
        max-width: none;
        min-width: 0;
      }
      .p-panel.slots{
        opacity:1;
        transform:none;
        pointer-events:auto;
        padding:16px;
        border-color: var(--rc-border);
        background:#fff;
        max-width:none;
        min-width:0;
      }
    }

    /* ======================================================
       MOBILE-ONLY MODS
       ====================================================== */
    @media (max-width: 640px){
      .p-hero{
        position: sticky;
        top: 0;
        z-index: 40;
        align-items:flex-start;
        padding: 12px 14px 10px;
        gap: 12px;
        backdrop-filter: blur(10px);
        background:
          radial-gradient(1000px 360px at 20% 0%, rgba(22,119,255,.14), transparent 60%),
          radial-gradient(900px 320px at 80% 20%, rgba(22,119,255,.10), transparent 55%),
          rgba(248,250,252,.88);
      }

      .p-avatar{ width:56px; height:56px; border-radius:18px; margin-top: 0; }

      .p-title{ margin: 8px 0 6px; font-size: 1.25rem; }
      .p-badge{ font-size:.85rem; padding:5px 9px; }
      .p-dot{ box-shadow: 0 0 0 3px rgba(22,119,255,.10); }

      .p-body{ padding: 12px 14px 18px; }

      .p-bio-wrap{
        position: relative;
        margin-top: 2px;
      }

      .p-bio-wrap:not(.is-open) #expertBio{
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
        overflow: hidden;
      }

      .p-bio-fade{
        pointer-events: none;
        position:absolute;
        left:0; right:0; bottom:0;
        height: 2.2em;
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1));
        opacity: 0;
        transition: opacity 160ms ease;
      }
      .p-bio-wrap:not(.is-open) .p-bio-fade{ opacity: 1; }

      .p-bio-toggle{
        position:absolute;
        right: 2px;
        bottom: -10px;
        width: 34px;
        height: 34px;
        border-radius: 999px;
        border: 1px solid rgba(22,119,255,.20);
        background: var(--rc-blue-grad);
        display:grid;
        place-items:center;
        cursor:pointer;
        user-select:none;
        box-shadow: 0 10px 20px rgba(22,119,255,.10);
        transition: transform 140ms ease, box-shadow 160ms ease, background-color 160ms ease;
      }
      .p-bio-toggle:hover{ transform: translateY(-1px); box-shadow: 0 14px 24px rgba(22,119,255,.14); }
      .p-bio-toggle:active{ transform: translateY(0); }
      .p-bio-toggle svg{ width:16px; height:16px; fill: var(--rc-blue); opacity:.9; }
      .p-bio-wrap.is-open .p-bio-toggle{ transform: rotate(180deg); }

      .p-bio-wrap.is-open .p-bio-fade{ opacity: 0; }

      .p-grid{ gap: 12px; }
      .p-panel{ padding: 14px; border-radius: 18px; }

      .p-book-head{ font-size: 1.05rem; margin-bottom: 8px; }
    }
  </style>
</head>

<body>

<header class="site-header">
  <div class="container header-inner">
    <a href="index.html" class="logo-link">
      <div class="logo">RunCall</div>
    </a>

    <!-- ✅ Premium, single-line on mobile (fits because full width under logo on mobile) -->
<div class="rc-tagline"
     data-fr="Un échange en visio pour poser toutes tes questions"
     data-en="A video chat to ask all your questions and improve">
  Un échange en visio pour poser toutes tes questions
</div>

  </div>
</header>

<div class="lang-switch">
  <button type="button" data-lang="fr">FR</button>
  <button type="button" data-lang="en">EN</button>
</div>

<section class="section p-page">
  <div class="container p-wrap">

    <div class="p-card">
      <div class="p-hero">
        <div class="p-avatar">
          <img id="expertPhoto" alt="Profile photo" />
          <div id="avatarFallback" class="p-avatar-fallback">R</div>
        </div>

        <div class="p-hero-main">
          <div class="p-badge">
            <span class="p-dot"></span>
            <span data-fr="Disponibilités RunCall" data-en="RunCall availability">Disponibilités RunCall</span>
          </div>

          <h1 class="p-title" id="expertName">—</h1>

          <div class="p-bio-wrap" id="bioWrap">
            <p class="p-subtitle" id="expertBio">—</p>
            <div class="p-bio-fade" aria-hidden="true"></div>
            <button class="p-bio-toggle" id="bioToggle" type="button" aria-label="Toggle bio" aria-expanded="false">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6.7 9.3a1 1 0 0 1 1.4 0L12 13.2l3.9-3.9a1 1 0 1 1 1.4 1.4l-4.6 4.6a1 1 0 0 1-1.4 0l-4.6-4.6a1 1 0 0 1 0-1.4z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="p-body">

        <div class="p-book-head" id="bookHeadline"
             data-fr="Réserver un échange avec PRENOM"
             data-en="Book a conversation with FIRST NAME">
          Réserver un échange avec PRENOM
        </div>

        <div class="p-grid" id="gridRoot">

          <div class="p-panel calendar" id="calendarPanel">
            <div class="p-month-head" id="monthHead">
              <button class="p-btn" id="prevMonth" type="button" aria-label="Previous month">←</button>
              <div class="p-month-title" id="monthTitle">—</div>
              <button class="p-btn" id="nextMonth" type="button" aria-label="Next month">→</button>
            </div>

            <div class="p-dow" id="dow"></div>
            <div id="calendar" class="p-month"></div>

            <div id="slotsError" class="p-error"></div>
          </div>

          <div class="p-panel slots" id="slotsPanel">
            <div id="slotsDate" class="p-slots-date">—</div>
            <div id="slotList" class="p-slot-list"></div>
          </div>

        </div>
      </div>
    </div>

  </div>
</section>

<div id="modalBackdrop" class="p-modal-backdrop" role="dialog" aria-modal="true">
  <div class="p-modal">
    <div class="p-modal-head">
      <div class="p-modal-title" id="modalTitle">Réserver</div>
      <button class="p-btn" id="closeModal" type="button" aria-label="Close">✕</button>
    </div>
    <div class="p-modal-body">
      <div class="p-muted" id="modalWhen" style="margin-top:0;"></div>

      <div class="p-form-row">
        <label data-fr="Ton nom" data-en="Your name">Ton nom</label>
        <input id="bookName" type="text" autocomplete="name" />
      </div>

      <div class="p-form-row">
        <label data-fr="Ton email" data-en="Your email">Ton email</label>
        <input id="bookEmail" type="email" autocomplete="email" />
      </div>

      <div class="p-form-row">
        <label data-fr="Note (optionnel)" data-en="Note (optional)">Note (optionnel)</label>
        <textarea id="bookNote" rows="3"></textarea>
      </div>

      <div id="modalError" class="p-error"></div>

      <div class="p-modal-actions">
        <button class="p-btn" id="goSupport" type="button" style="flex:1;" data-fr="Continuer" data-en="Continue">Continuer</button>
        <button class="p-btn" id="cancelModal" type="button" style="flex:1;" data-fr="Annuler" data-en="Cancel">Annuler</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  // ---------- Language ----------
  const buttons = document.querySelectorAll('.lang-switch button');
  let lang = localStorage.getItem('runcall_lang');
  if (!lang) {
    const browserLang = navigator.language || navigator.userLanguage;
    lang = (browserLang || "").toLowerCase().startsWith('fr') ? 'fr' : 'en';
  }
  function applyLanguage(nextLang) {
    lang = nextLang;
    document.querySelectorAll('[data-fr][data-en]').forEach(el => {
      el.textContent = el.dataset[lang];
    });
    buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
    localStorage.setItem('runcall_lang', lang);
    renderDow();
    renderCalendar();
    updateBookHeadline();
  }
  buttons.forEach(btn => btn.addEventListener('click', () => applyLanguage(btn.dataset.lang)));
  applyLanguage(lang);

  // ---------- Helpers ----------
  const qs = new URLSearchParams(window.location.search);
  const expertId = qs.get("expert_id");
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";

  function iso(d){ return d.toISOString(); }

  function localKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function showError(el, msg){
    el.style.display = "block";
    el.textContent = msg;
  }
  function clearError(el){
    el.style.display = "none";
    el.textContent = "";
  }

  function fmtMonthTitle(d){
    return new Intl.DateTimeFormat(lang === "fr" ? "fr-FR" : "en-US", { month:"long", year:"numeric" }).format(d);
  }

  function fmtSlotsHeader(d){
    return new Intl.DateTimeFormat(lang==="fr"?"fr-FR":"en-US", { weekday:"long", month:"long", day:"numeric" }).format(d);
  }

  function fmtTime(d){
    return new Intl.DateTimeFormat("en-US", { hour:"numeric", minute:"2-digit", hour12:true }).format(d);
  }

  function firstNameFromFullName(full){
    const s = String(full || "").trim();
    if (!s) return "";
    return s.split(/\s+/)[0];
  }
  function updateBookHeadline(){
    const h = document.getElementById("bookHeadline");
    if (!h) return;
    const fullName = document.getElementById("expertName")?.textContent || "";
    const first = firstNameFromFullName(fullName) || (lang === "fr" ? "cet intervenant" : "this expert");

    const frTpl = h.dataset.fr || "Réserver un échange avec PRENOM";
    const enTpl = h.dataset.en || "Book a conversation with FIRST NAME";

    h.textContent = (lang === "fr")
      ? frTpl.replace("PRENOM", first)
      : enTpl.replace("FIRST NAME", first);
  }

  function renderDow(){
    const el = document.getElementById("dow");
    if (!el) return;
    el.innerHTML = "";

    const base = new Date(2026, 0, 5, 12, 0, 0, 0); // Monday
    for (let i=0;i<7;i++){
      const d = new Date(base);
      d.setDate(base.getDate()+i);
      const label = new Intl.DateTimeFormat(lang==="fr"?"fr-FR":"en-US", { weekday:"short" }).format(d);
      const cell = document.createElement("div");
      cell.textContent = label.replace(".","").toUpperCase();
      el.appendChild(cell);
    }
  }

  // ---------- Load expert profile ----------
  async function loadExpert(){
    if (!expertId) {
      document.getElementById("expertName").textContent = (lang === "fr" ? "Profil introuvable" : "Profile not found");
      document.getElementById("expertBio").textContent = (lang === "fr" ? "Lien invalide." : "Invalid link.");
      updateBookHeadline();
      return;
    }

    try{
      const r = await fetch(`/api/experts/get?expert_id=${encodeURIComponent(expertId)}`);
      if (!r.ok) throw new Error("fetch failed");
      const d = await r.json();

      const name = d?.name || "—";
      document.getElementById("expertName").textContent = name;
      document.getElementById("expertBio").textContent = d?.presentation || "—";
      updateBookHeadline();

      const img = document.getElementById("expertPhoto");
      const fallback = document.getElementById("avatarFallback");
      const initial = String(name || "R").trim().slice(0,1).toUpperCase() || "R";
      fallback.textContent = initial;

      const photoUrl = d?.photo_url || "";
      if (photoUrl) {
        img.onload = () => { img.style.display = "block"; fallback.style.display = "none"; };
        img.onerror = () => { img.style.display = "none"; fallback.style.display = "grid"; };
        img.src = photoUrl;
      } else {
        img.style.display = "none";
        fallback.style.display = "grid";
      }
    } catch {
      document.getElementById("expertName").textContent = (lang === "fr" ? "Intervenant RunCall" : "RunCall expert");
      document.getElementById("expertBio").textContent = (lang === "fr"
        ? "Ce profil est en cours de configuration."
        : "This profile is being set up.");
      updateBookHeadline();

      const fallback = document.getElementById("avatarFallback");
      fallback.textContent = "R";
      document.getElementById("expertPhoto").style.display = "none";
      fallback.style.display = "grid";
    }
  }

  // ---------- Slots fetch ----------
  async function fetchSlots(from, to){
    const url = `/api/experts/slots?expert_id=${encodeURIComponent(expertId)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&tz=${encodeURIComponent(tz)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("slots fetch failed");
    const d = await r.json();
    return Array.isArray(d?.slots) ? d.slots : [];
  }

  function groupSlotsByDay(slots){
    const map = new Map();
    slots.forEach(s => {
      const start = new Date(s.start);
      const key = localKey(start);
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(s);
    });
    for (const [k, arr] of map.entries()){
      arr.sort((a,b) => new Date(a.start) - new Date(b.start));
      map.set(k, arr);
    }
    return map;
  }

  // ---------- Month calendar state ----------
  const gridRoot = document.getElementById("gridRoot");
  let viewMonth = (function(){
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
  })();

  let latestGrouped = new Map();
  let selectedDayKey = null;
  let selectedSlot = null;

  function startOfWeekMonday(d){
    const x = new Date(d);
    const day = x.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    x.setDate(x.getDate() + diff);
    x.setHours(0,0,0,0);
    return x;
  }
  function endOfWeekSunday(d){
    const x = startOfWeekMonday(d);
    x.setDate(x.getDate() + 6);
    x.setHours(23,59,59,999);
    return x;
  }

  function monthGridRange(monthStart){
    const first = new Date(monthStart.getFullYear(), monthStart.getMonth(), 1, 0,0,0,0);
    const last = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0, 23,59,59,999);
    const gridStart = startOfWeekMonday(first);
    const gridEnd = endOfWeekSunday(last);
    return { gridStart, gridEnd };
  }

  function buildMonthDays(monthStart){
    const { gridStart, gridEnd } = monthGridRange(monthStart);
    const days = [];
    const cur = new Date(gridStart);
    while (cur <= gridEnd){
      days.push(new Date(cur));
      cur.setDate(cur.getDate() + 1);
    }
    return days;
  }

  // ✅ MOBILE: scroll down, but stop so month header (title + arrows) stays visible
  function isMobile(){
    return window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
  }
  function scrollToShowSlotsButKeepMonthHeader(){
    if (!isMobile()) return;

    const slotsPanel = document.getElementById("slotsPanel");
    const monthHead = document.getElementById("monthHead");
    if (!slotsPanel || !monthHead) return;

    const y0 = window.scrollY;
    const slotsTop = slotsPanel.getBoundingClientRect().top;     // relative to viewport
    const headTop  = monthHead.getBoundingClientRect().top;      // relative to viewport

    // We want slots to come into view (around middle), BUT month header must stay visible near top.
    const desiredSlotsTop = Math.round(window.innerHeight * 0.58);
    let delta = slotsTop - desiredSlotsTop; // positive => scroll down

    // If delta <= 0, slots already visible enough; still do a tiny scroll to "confirm" the action
    // but don't move month head out.
    if (delta <= 0) delta = 12;

    // Cap delta so month header stays visible (>= 10px from top)
    const minHeadTop = 10;
    const headTopAfter = headTop - delta;
    if (headTopAfter < minHeadTop){
      delta = headTop - minHeadTop; // scroll just enough to pin header at 10px
    }

    // If delta is tiny/negative after cap, no-op
    if (delta > 2){
      window.scrollTo({ top: y0 + delta, behavior: "smooth" });
    }
  }

  function setSlotsPanel(dayKey){
    const list = document.getElementById("slotList");
    const header = document.getElementById("slotsDate");
    list.innerHTML = "";

    selectedDayKey = dayKey;

    if (!dayKey){
      gridRoot.classList.remove("has-day");
      return;
    }

    const daySlots = latestGrouped.get(dayKey) || [];

    const parts = dayKey.split("-").map(Number);
    const d = new Date(parts[0], parts[1]-1, parts[2], 12, 0, 0, 0);
    header.textContent = fmtSlotsHeader(d);

    daySlots.forEach(s => {
      const a = document.createElement("a");
      a.className = "p-slot";
      a.href = "#";
      a.textContent = fmtTime(new Date(s.start));
      a.addEventListener("click", (ev) => {
        ev.preventDefault();
        openModal(s);
      });
      list.appendChild(a);
    });

    gridRoot.classList.add("has-day");

    // ✅ scroll AFTER slots have rendered (ensures it actually scrolls)
    if (daySlots.length > 0){
      requestAnimationFrame(() => scrollToShowSlotsButKeepMonthHeader());
    }
  }

  function highlightSelectedDay(){
    document.querySelectorAll(".p-mday").forEach(el => {
      const k = el.getAttribute("data-daykey");
      el.classList.toggle("is-selected", !!selectedDayKey && k === selectedDayKey);
    });
  }

  async function renderCalendar(){
    renderDow();
    document.getElementById("monthTitle").textContent = fmtMonthTitle(viewMonth);

    const cal = document.getElementById("calendar");
    const err = document.getElementById("slotsError");
    clearError(err);
    cal.innerHTML = "";

    if (!expertId){
      showError(err, lang === "fr" ? "Lien invalide (expert_id manquant)." : "Invalid link (missing expert_id).");
      latestGrouped = new Map();
      if (!selectedDayKey) setSlotsPanel(null);
      return;
    }

    const days = buildMonthDays(viewMonth);
    const { gridStart, gridEnd } = monthGridRange(viewMonth);

    let slots = [];
    try{
      slots = await fetchSlots(iso(gridStart), iso(gridEnd));
    } catch(e){
      showError(err, lang === "fr"
        ? "Impossible de charger les créneaux pour le moment."
        : "Unable to load slots right now.");
      slots = [];
    }

    latestGrouped = groupSlotsByDay(slots);

    const currentMonth = viewMonth.getMonth();

    days.forEach(d => {
      const key = localKey(d);
      const daySlots = latestGrouped.get(key) || [];
      const hasAny = daySlots.length > 0;

      const cell = document.createElement("div");
      cell.className = "p-mday " + (hasAny ? "has-any" : "no-any");
      cell.setAttribute("data-daykey", key);

      if (d.getMonth() !== currentMonth) {
        cell.classList.add("is-out");
        cell.textContent = "";
        cal.appendChild(cell);
        return;
      }

      cell.textContent = String(d.getDate());

      cell.addEventListener("click", () => {
        setSlotsPanel(key);
        highlightSelectedDay();
      });

      cal.appendChild(cell);
    });

    if (!selectedDayKey){
      gridRoot.classList.remove("has-day");
    } else {
      gridRoot.classList.add("has-day");
      highlightSelectedDay();
    }
  }

  // ---------- Modal booking ----------
  const backdrop = document.getElementById("modalBackdrop");
  const closeModalBtn = document.getElementById("closeModal");
  const cancelModalBtn = document.getElementById("cancelModal");
  const goSupportBtn = document.getElementById("goSupport");
  const modalTitle = document.getElementById("modalTitle");
  const modalWhen = document.getElementById("modalWhen");
  const modalError = document.getElementById("modalError");

function openModal(slot){
  selectedSlot = slot;
  modalError.style.display = "none";
  modalError.textContent = "";

  const start = new Date(slot.start);
  const end = new Date(slot.end);

  modalTitle.textContent = (lang === "fr" ? "Réserver ce créneau" : "Book this slot");
  modalWhen.textContent = `${fmtSlotsHeader(start)} • ${fmtTime(start)} – ${fmtTime(end)} (${tz})`;

  // Open modal
  backdrop.classList.add("is-open");

  // Lock background scroll
  document.documentElement.classList.add("modal-open");
  document.body.classList.add("modal-open");

  // Focus (small delay avoids iOS weirdness)
  setTimeout(() => {
    document.getElementById("bookName").focus({ preventScroll: true });
  }, 50);
}

function closeModal(){
  // Close modal
  backdrop.classList.remove("is-open");

  // Unlock background scroll
  document.documentElement.classList.remove("modal-open");
  document.body.classList.remove("modal-open");

  selectedSlot = null;
}


  closeModalBtn.addEventListener("click", closeModal);
  cancelModalBtn.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e) => {
  if (e.target.classList.contains("modal-backdrop")) closeModal();
});


  goSupportBtn.addEventListener("click", () => {
    modalError.style.display = "none";
    modalError.textContent = "";

    const name = document.getElementById("bookName").value.trim();
    const email = document.getElementById("bookEmail").value.trim();
    const note = document.getElementById("bookNote").value.trim();

    if (!selectedSlot) {
      modalError.style.display = "block";
      modalError.textContent = (lang === "fr" ? "Créneau invalide." : "Invalid slot.");
      return;
    }
    if (!name || !email) {
      modalError.style.display = "block";
      modalError.textContent = (lang === "fr" ? "Merci de remplir ton nom et ton email." : "Please enter your name and email.");
      return;
    }

    const url = new URL("support.html", window.location.origin);
    url.searchParams.set("expert_id", expertId || "");
    url.searchParams.set("slot_start", selectedSlot.start);
    url.searchParams.set("slot_end", selectedSlot.end);
    url.searchParams.set("tz", tz);
    url.searchParams.set("name", name);
    url.searchParams.set("email", email);
    if (note) url.searchParams.set("note", note);

    window.location.href = url.toString();
  });

  // ---------- Month nav ----------
  document.getElementById("prevMonth").addEventListener("click", () => {
    viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth() - 1, 1);
    renderCalendar();
  });
  document.getElementById("nextMonth").addEventListener("click", () => {
    viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth() + 1, 1);
    renderCalendar();
  });

  // ======================================================
  // MOBILE bio collapse/expand
  // ======================================================
(function initMobileBio(){
  const wrap = document.getElementById("bioWrap");
  const btn  = document.getElementById("bioToggle");
  if (!wrap || !btn) return;

  const mq = window.matchMedia("(max-width: 640px)");

  function setOpen(open){
    wrap.classList.toggle("is-open", open);
    btn.setAttribute("aria-expanded", open ? "true" : "false");
  }

  function apply(){
    if (!mq.matches){
      setOpen(true);
      btn.style.display = "none";
      return;
    }
    btn.style.display = "grid";
    setOpen(false);
  }

  btn.addEventListener("click", () => {
    setOpen(!wrap.classList.contains("is-open"));
  });

  apply();
  window.addEventListener("resize", () => {
    const wasOpen = wrap.classList.contains("is-open");
    apply();
    if (wasOpen) setOpen(true);
  });

  window.__rcBioApply = apply;
})();

  // Init
  loadExpert().then(() => {
    updateBookHeadline();
    renderCalendar();
    if (window.__rcBioApply) window.__rcBioApply();
  });
})();
</script>

</body>
</html>
