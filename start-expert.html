<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>RunCall – Démarrer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Scoped to this page only (aligned with devenir-intervenant-v2.html) */
    .start-page{ background:#f8fafc; }
    .start-wrap{ max-width: 860px; margin: 0 auto; padding: 18px 0 46px; }
    .start-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(15,23,42,.08);
      overflow:hidden;
    }
    .start-hero{
      padding: 26px 24px 18px;
      border-bottom:1px solid #e5e7eb;
      background: radial-gradient(900px 320px at 20% 0%, rgba(22,119,255,.12), transparent 58%);
    }
    .start-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid #e5e7eb; background:#fff;
      color:#475569; font-size:.9rem;
    }
    .start-dot{ width:8px; height:8px; border-radius:999px; background:#1677ff; }
    .start-title{
      margin: 14px 0 6px;
      font-size: 1.7rem; line-height:1.2;
      letter-spacing:-.02em; color:#0f172a;
    }
    .start-subtitle{
      margin:0; color:#475569; line-height:1.55;
      font-size:1.02rem; max-width: 75ch;
    }

    .start-body{ padding: 20px 24px 24px; }

    .start-grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:start;
      margin-top: 14px;
    }

    .start-panel{
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:16px;
      background:#fff;
    }

    .start-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:100%;
      padding: 12px 14px;
      border-radius: 16px;
      border:1px solid #1677ff;
      background: rgba(22,119,255,.10);
      color:#0f172a;
      text-decoration:none;
      font-weight:800;
      letter-spacing:-.01em;
      cursor:pointer;
      transition: transform 140ms ease, box-shadow 160ms ease, background-color 160ms ease;
      user-select:none;
      gap:10px;
    }
    .start-btn:hover{
      transform: translateY(-1px);
      background: rgba(22,119,255,.14);
      box-shadow: 0 12px 26px rgba(22,119,255,.12);
    }
    .start-btn:active{ transform: translateY(0); }
    .start-btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
    }

    .gmark{ width:18px; height:18px; display:inline-block; }

    .start-secondary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:100%;
      padding: 11px 14px;
      border-radius: 16px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#0f172a;
      text-decoration:none;
      transition: transform 140ms ease, border-color 160ms ease, background-color 160ms ease;
      cursor:pointer;
    }
    .start-secondary:hover{
      transform: translateY(-1px);
      border-color:#1677ff;
      background: rgba(22,119,255,.06);
    }

    .start-sep{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 14px 0;
      color:#94a3b8;
      font-size:.92rem;
    }
    .start-sep:before,
    .start-sep:after{
      content:"";
      height:1px;
      background:#e5e7eb;
      flex:1;
    }

    .start-form .row{ margin: 0 0 12px; }
    .start-form label{
      display:block;
      font-weight:700;
      color:#0f172a;
      margin-bottom:6px;
    }
    .start-form input[type="email"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#0f172a;
      outline:none;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }
    .start-form input:focus{
      border-color:#1677ff;
      box-shadow: 0 0 0 4px rgba(22,119,255,.10);
    }

    .start-small{
      display:block;
      color:#64748b;
      font-size:.95rem;
      line-height:1.55;
      margin-top:8px;
    }

    .start-alert{
      margin-top: 12px;
      border-radius: 14px;
      border:1px solid #e5e7eb;
      background: #ffffff;
      padding: 12px 12px;
      color:#475569;
      font-size: .95rem;
      line-height: 1.55;
    }
    .start-alert strong{ color:#0f172a; }

    .start-msg{
      display:none;
      margin-top: 12px;
      border-radius: 14px;
      border:1px solid #e5e7eb;
      background:#ffffff;
      padding: 12px 12px;
      color:#475569;
      font-size:.95rem;
      line-height:1.55;
    }
    .start-msg.is-error{
      border-color:#fecaca;
      background:#fff1f2;
      color:#881337;
    }
    .start-msg.is-ok{
      border-color:#bbf7d0;
      background:#f0fdf4;
      color:#166534;
    }

    @media (max-width: 820px){
      .start-grid{ grid-template-columns: 1fr; }
      .start-title{ font-size: 1.45rem; }
    }
  </style>
</head>

<body>

<header class="site-header">
  <div class="container header-inner">
    <a href="index.html" class="logo-link">
      <div class="logo">RunCall</div>
    </a>
  </div>
</header>

<div class="lang-switch">
  <button type="button" data-lang="fr">FR</button>
  <button type="button" data-lang="en">EN</button>
</div>

<section class="section start-page">
  <div class="container start-wrap">

    <div class="start-card">
      <div class="start-hero">
        <div class="start-badge">
          <span class="start-dot"></span>
          <span data-fr="Démarrer" data-en="Get started"></span>
        </div>

        <h1 class="start-title"
            data-fr="Partager ton expérience sur RunCall"
            data-en="Share your experience on RunCall"></h1>

        <p class="start-subtitle"
           data-fr="Commence par te connecter. Ensuite, tu complèteras ton profil puis tu connecteras Google Calendar pour ouvrir tes disponibilités."
           data-en="Start by signing in. Then you’ll complete your profile and connect Google Calendar to open your availability."></p>
      </div>

      <div class="start-body">
        <div class="start-grid">

          <!-- LEFT: options -->
          <div class="start-panel">
            <button id="googleBtn" class="start-btn" type="button">
              <svg class="gmark" viewBox="0 0 48 48" aria-hidden="true">
                <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.7 32.7 29.3 36 24 36 16.8 36 11 30.2 11 23S16.8 10 24 10c3.1 0 5.9 1.1 8.1 2.9l5.7-5.7C34.2 4 29.4 2 24 2 12.9 2 4 10.9 4 22s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.7-.4-3.5z"/>
                <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 15.3 19 12 24 12c3.1 0 5.9 1.1 8.1 2.9l5.7-5.7C34.2 4 29.4 2 24 2 16.3 2 9.6 6.3 6.3 14.7z"/>
                <path fill="#4CAF50" d="M24 42c5.3 0 10.2-2 13.9-5.2l-6.4-5.3C29.4 33 26.8 34 24 34c-5.2 0-9.6-3.3-11.2-7.9l-6.6 5.1C9.4 38.7 16.2 42 24 42z"/>
                <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.1 3-3.4 5.3-6.3 6.8l.1.1 6.4 5.3C34.9 42.1 44 37 44 22c0-1.3-.1-2.7-.4-3.5z"/>
              </svg>
              <span id="googleBtnLabel" data-fr="Continuer avec Google" data-en="Continue with Google"></span>
            </button>

            <div class="start-alert">
              <strong data-fr="Note :" data-en="Note:"></strong>
              <span data-fr=" Google Calendar sera nécessaire à l’étape suivante pour ouvrir tes créneaux."
                    data-en=" Google Calendar will be required in the next step to open your availability."></span>
            </div>

            <div class="start-sep" data-fr="ou" data-en="or"></div>

            <form id="magicForm" class="start-form" novalidate>
              <div class="row">
                <label data-fr="Continuer par email (lien magique)"
                       data-en="Continue with email (magic link)"></label>
                <input id="email" type="email" autocomplete="email" placeholder="you@example.com" required />
                <small class="start-small"
                  data-fr="On t’enverra un lien de connexion. Pas de mot de passe."
                  data-en="We’ll email you a secure sign-in link. No password."></small>
              </div>

              <button id="magicBtn" class="start-secondary" type="submit"
                data-fr="M’envoyer un lien"
                data-en="Send me a link"></button>

              <div id="msgBox" class="start-msg"></div>
            </form>
          </div>

          <!-- RIGHT: info -->
          <div class="start-panel">
            <ol class="start-small" style="margin:0; padding-left:18px;">
              <li data-fr="Connexion (Google ou email)" data-en="Sign in (Google or email)"></li>
              <li data-fr="Création du profil" data-en="Create your profile"></li>
              <li data-fr="Connexion Google Calendar" data-en="Connect Google Calendar"></li>
              <li data-fr="Ouverture des créneaux via des events “RunCall”" data-en="Open slots with “RunCall” events"></li>
            </ol>

            <div style="height:12px;"></div>
            <a class="start-secondary" href="index.html"
              data-fr="Retour à RunCall"
              data-en="Back to RunCall"></a>
          </div>

        </div>
      </div>
    </div>

  </div>
</section>

<script>
(function () {
  // ---------- Language ----------
  const buttons = document.querySelectorAll('.lang-switch button');
  let lang = localStorage.getItem('runcall_lang');
  if (!lang) {
    const browserLang = (navigator.language || "").toLowerCase();
    lang = browserLang.startsWith('fr') ? 'fr' : 'en';
  }
  function applyLanguage(nextLang) {
    document.querySelectorAll('[data-fr][data-en]').forEach(el => {
      el.textContent = el.dataset[nextLang];
    });
    buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.lang === nextLang));
    localStorage.setItem('runcall_lang', nextLang);
    lang = nextLang;
  }
  buttons.forEach(btn => btn.addEventListener('click', () => applyLanguage(btn.dataset.lang)));
  applyLanguage(lang);

  // ---------- Supabase ----------
  const SUPABASE_URL = "https://bflptoazeqfcultpukkh.supabase.co";
  const SUPABASE_PUBLISHABLE_KEY = "sb_publishable__ZleRKOics4yZv3UwIUPiA_22xmqUM4";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

  // IMPORTANT: always return here after OAuth/magic link so we can create the DB row + redirect with expert_id
  const RETURN_URL = "https://www.run-call.com/start-expert.html";

  const googleBtn = document.getElementById("googleBtn");
  const googleBtnLabel = document.getElementById("googleBtnLabel");
  const magicForm = document.getElementById("magicForm");
  const magicBtn = document.getElementById("magicBtn");
  const msgBox = document.getElementById("msgBox");

  let inFlight = false;

  function showMsg(type, text){
    msgBox.className = "start-msg " + (type === "error" ? "is-error" : "is-ok");
    msgBox.style.display = "block";
    msgBox.textContent = text;
  }
  function clearMsg(){
    msgBox.style.display = "none";
    msgBox.textContent = "";
    msgBox.className = "start-msg";
  }

  function setGoogleLoading(isLoading){
    googleBtn.disabled = isLoading;
    googleBtnLabel.textContent = isLoading
      ? (lang === "fr" ? "Chargement..." : "Loading...")
      : (lang === "fr" ? googleBtnLabel.dataset.fr : googleBtnLabel.dataset.en);
  }

  function setMagicLoading(isLoading){
    magicBtn.disabled = isLoading;
    magicBtn.textContent = isLoading
      ? (lang === "fr" ? "Chargement..." : "Loading...")
      : (lang === "fr" ? magicBtn.dataset.fr : magicBtn.dataset.en);
  }

  function getNameFromUser(user){
    const md = user?.user_metadata || {};
    return (md.full_name || md.name || "").trim();
  }

  async function ensureIntervenantRowAndRedirect(user){
  const authUserId = user.id;
  const email = (user.email || "").trim().toLowerCase() || null;
  const name = getNameFromUser(user) || null;

  // 1) Try to find existing row by auth_user_id
  const { data: existing, error: findErr } = await supabase
    .from("experts")
    .select("id, auth_user_id")
    .eq("auth_user_id", authUserId)
    .maybeSingle();

  if (findErr) throw findErr;

  // 2) If exists -> update (non destructif)
  if (existing?.id) {
    const { data: updated, error: updErr } = await supabase
      .from("experts")
      .update({
        email,
        name,
        source: "auth_onboarding",
        status: "draft",
        updated_at: new Date().toISOString()
      })
      .eq("id", existing.id)
      .select("id")
      .single();

    if (updErr) throw updErr;

    window.location.href = `devenir-intervenant-v2.html?expert_id=${encodeURIComponent(updated.id)}`;
    return;
  }

  // 3) Else -> insert new
  const { data: created, error: insErr } = await supabase
    .from("experts")
    .insert({
      auth_user_id: authUserId,
      email,
      name,
      presentation: null,
      photo_url: null,
      source: "auth_onboarding",
      status: "draft"
    })
    .select("id")
    .single();

  if (insErr) throw insErr;

  window.location.href = `devenir-intervenant-v2.html?expert_id=${encodeURIComponent(created.id)}`;
}


  async function finalizeIfAuthed(){
    if (inFlight) return;
    inFlight = true;

    try {
      const { data, error } = await supabase.auth.getSession();
      if (error) throw error;

      const user = data?.session?.user;
      if (!user) { inFlight = false; return; }

      clearMsg();
      setGoogleLoading(true);
      setMagicLoading(true);

      // Only show OK once we know DB is fine
      showMsg("ok", lang === "fr"
        ? "Connexion réussie. Finalisation…"
        : "Signed in. Finalizing…");

      await ensureIntervenantRowAndRedirect(user);
    } catch (e) {
      console.error(e);
      setGoogleLoading(false);
      setMagicLoading(false);
      showMsg("error", (lang === "fr"
        ? "Impossible de finaliser ton compte intervenant : "
        : "Unable to finalize your account: ") + (e?.message || "unknown error"));
      inFlight = false;
    }
  }

  // Run on load (handles return from Google OAuth / magic link)
  finalizeIfAuthed();

  // Also listen to auth changes (session sometimes arrives after first paint)
  supabase.auth.onAuthStateChange(() => {
    finalizeIfAuthed();
  });

  // Google sign-in
  googleBtn.addEventListener("click", async () => {
    clearMsg();
    setGoogleLoading(true);

    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: RETURN_URL }
      });
      if (error) throw error;
      // redirect happens automatically
    } catch (e) {
      setGoogleLoading(false);
      showMsg("error", e?.message || (lang === "fr"
        ? "Impossible de démarrer Google. Vérifie la config Supabase/Google."
        : "Unable to start Google. Check Supabase/Google configuration."));
    }
  });

  // Magic link
  magicForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMsg();

    const email = (document.getElementById("email").value || "").trim();
    if (!email) {
      showMsg("error", lang === "fr" ? "Entre une adresse email." : "Enter an email address.");
      return;
    }

    setMagicLoading(true);

    try {
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: RETURN_URL }
      });
      if (error) throw error;

      showMsg("ok", lang === "fr"
        ? "Lien envoyé. Vérifie ta boîte mail (et tes spams)."
        : "Link sent. Check your inbox (and spam).");
    } catch (e) {
      showMsg("error", e?.message || (lang === "fr"
        ? "Impossible d’envoyer le lien. Réessaie."
        : "Unable to send the link. Please try again."));
    } finally {
      setMagicLoading(false);
    }
  });
})();
</script>

</body>
</html>
