<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>RunCall – Démarrer (Expert)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .join-page{ background:#f8fafc; }
    .join-wrap{ max-width: 860px; margin: 0 auto; padding: 18px 0 46px; }
    .join-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(15,23,42,.08);
      overflow:hidden;
    }
    .join-hero{
      padding: 26px 24px 18px;
      border-bottom:1px solid #e5e7eb;
      background: radial-gradient(900px 320px at 20% 0%, rgba(22,119,255,.12), transparent 58%);
    }
    .join-badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid #e5e7eb; background:#fff;
      color:#475569; font-size:.9rem;
    }
    .join-dot{ width:8px; height:8px; border-radius:999px; background:#1677ff; }
    .join-title{
      margin: 14px 0 6px;
      font-size: 1.7rem; line-height:1.2;
      letter-spacing:-.02em; color:#0f172a;
    }
    .join-subtitle{
      margin:0; color:#475569; line-height:1.55;
      font-size:1.02rem; max-width: 75ch;
    }

    .join-body{ padding: 20px 24px 24px; }
    .join-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      align-items:start;
      margin-top: 14px;
    }
    .join-panel{
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:16px;
      background:#fff;
    }

    .btn-primary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:100%;
      padding: 12px 14px;
      border-radius: 16px;
      border:1px solid #1677ff;
      background: rgba(22,119,255,.10);
      color:#0f172a;
      text-decoration:none;
      font-weight:800;
      letter-spacing:-.01em;
      cursor:pointer;
      transition: transform 140ms ease, box-shadow 160ms ease, background-color 160ms ease;
      user-select:none;
    }
    .btn-primary:hover{
      transform: translateY(-1px);
      background: rgba(22,119,255,.14);
      box-shadow: 0 12px 26px rgba(22,119,255,.12);
    }
    .btn-primary:active{ transform: translateY(0); }
    .btn-primary[disabled]{ opacity:.6; cursor:not-allowed; transform:none !important; box-shadow:none !important; }

    .btn-secondary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:100%;
      padding: 11px 14px;
      border-radius: 16px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#0f172a;
      text-decoration:none;
      transition: transform 140ms ease, border-color 160ms ease, background-color 160ms ease;
      cursor:pointer;
    }
    .btn-secondary:hover{
      transform: translateY(-1px);
      border-color:#1677ff;
      background: rgba(22,119,255,.06);
    }

    .row{ margin: 0 0 12px; }
    label{ display:block; font-weight:700; color:#0f172a; margin-bottom:6px; }
    input[type="email"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#0f172a;
      outline:none;
      transition: border-color 160ms ease, box-shadow 160ms ease;
    }
    input:focus{
      border-color:#1677ff;
      box-shadow: 0 0 0 4px rgba(22,119,255,.10);
    }

    .muted{ color:#64748b; font-size:.95rem; line-height:1.55; margin-top:8px; }
    .ok{ color:#065f46; background:#ecfdf5; border:1px solid #bbf7d0; padding:10px 12px; border-radius:14px; display:none; }
    .err{ color:#881337; background:#fff1f2; border:1px solid #fecaca; padding:10px 12px; border-radius:14px; display:none; }

    .divider{
      display:flex; align-items:center; gap:10px;
      margin: 14px 0;
      color:#94a3b8; font-weight:700; font-size:.85rem;
    }
    .divider:before,.divider:after{ content:""; height:1px; background:#e5e7eb; flex:1; }

    @media (max-width: 820px){
      .join-title{ font-size: 1.45rem; }
    }
  </style>
</head>

<body>
<header class="site-header">
  <div class="container header-inner">
    <a href="index.html" class="logo-link">
      <div class="logo">RunCall</div>
    </a>
  </div>
</header>

<section class="section join-page">
  <div class="container join-wrap">

    <div class="join-card">
      <div class="join-hero">
        <div class="join-badge">
          <span class="join-dot"></span>
          <span>Démarrer (Expert)</span>
        </div>

        <h1 class="join-title">Partager ton expérience sur RunCall</h1>

        <p class="join-subtitle">
          Connecte-toi avec Google (recommandé) ou reçois un lien de connexion par email.
          Ensuite tu complètes ton profil et tu connectes ton Google Calendar.
        </p>
      </div>

      <div class="join-body">
        <div class="join-grid">

          <div class="join-panel">
            <div id="okBox" class="ok"></div>
            <div id="errBox" class="err"></div>

            <button id="googleBtn" class="btn-primary" type="button">
              Continuer avec Google
            </button>

            <div class="divider">ou</div>

            <div class="row">
              <label for="email">Connexion par email (lien magique)</label>
              <input id="email" type="email" placeholder="ton@email.com" autocomplete="email" />
              <div class="muted">
                On t’envoie un lien. Pas de mot de passe.
              </div>
            </div>

            <button id="magicBtn" class="btn-secondary" type="button">
              M’envoyer le lien de connexion
            </button>

            <div class="muted" style="margin-top:12px;">
              En continuant, tu acceptes que RunCall lise/écrive sur ton Google Calendar uniquement pour gérer tes créneaux et créer les événements de sessions.
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</section>

<!-- Supabase JS (UMD) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
(function () {
  const SUPABASE_URL = "https://bflptoazeqfcultpukkh.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable__ZleRKOics4yZv3UwIUPiA_22xmqUM4";
  const REDIRECT_URL = "https://www.run-call.com/start-expert.html"; // important: stable, no edit

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const googleBtn = document.getElementById("googleBtn");
  const magicBtn = document.getElementById("magicBtn");
  const emailInput = document.getElementById("email");
  const okBox = document.getElementById("okBox");
  const errBox = document.getElementById("errBox");

  function showOk(msg){ okBox.style.display="block"; okBox.textContent=msg; }
  function showErr(msg){ errBox.style.display="block"; errBox.textContent=msg; }
  function clearBoxes(){ okBox.style.display="none"; okBox.textContent=""; errBox.style.display="none"; errBox.textContent=""; }

  function setLoading(btn, isLoading, textLoading, textIdle){
    btn.disabled = isLoading;
    btn.textContent = isLoading ? textLoading : textIdle;
  }

  function getNameFromUser(user){
    // Supabase user metadata for Google usually contains full_name / name
    const md = user?.user_metadata || {};
    return (md.full_name || md.name || "").trim();
  }

  async function ensureExpertRow(user){
    const authUserId = user.id;
    const email = (user.email || "").trim().toLowerCase();
    const name = getNameFromUser(user);

    // 1) try find by auth_user_id
    let { data: existing, error: e1 } = await sb
      .from("experts")
      .select("id,name,email,presentation,photo_url,auth_user_id,status")
      .eq("auth_user_id", authUserId)
      .maybeSingle();

    // if not found and we have email: try find by email to "attach" auth_user_id
    if (!existing && email) {
      const { data: byEmail } = await sb
        .from("experts")
        .select("id,name,email,presentation,photo_url,auth_user_id,status")
        .eq("email", email)
        .maybeSingle();
      existing = byEmail || null;
    }

    // 2) if exists, update auth_user_id + name/email if missing
    if (existing?.id) {
      const patch = {
        auth_user_id: existing.auth_user_id || authUserId,
        email: existing.email || email,
        name: existing.name || name,
        updated_at: new Date().toISOString()
      };

      const { data: updated, error: e2 } = await sb
        .from("experts")
        .update(patch)
        .eq("id", existing.id)
        .select("id,name,email,presentation,photo_url,auth_user_id,status")
        .single();

      if (e2) throw e2;
      return updated;
    }

    // 3) else create new
    const insert = {
      auth_user_id: authUserId,
      email: email || null,
      name: name || null,
      presentation: null,
      photo_url: null,
      source: "auth_onboarding",
      status: "draft"
    };

    const { data: created, error: e3 } = await sb
      .from("experts")
      .insert(insert)
      .select("id,name,email,presentation,photo_url,auth_user_id,status")
      .single();

    if (e3) throw e3;
    return created;
  }

  function redirectNext(expert){
  window.location.href = `devenir-intervenant-v2.html?expert_id=${encodeURIComponent(expert.id)}`;
}


  async function postLoginFlow(){
    clearBoxes();

    const { data: { session }, error } = await sb.auth.getSession();
    if (error) {
      showErr("Erreur session: " + (error.message || "inconnue"));
      return;
    }
    if (!session?.user) return; // not logged in

    showOk("Connexion réussie. Finalisation…");

    try {
      const expert = await ensureExpertRow(session.user);
      redirectNext(expert);
    } catch (e) {
      console.error(e);
      showErr("Erreur création profil expert: " + (e?.message || "inconnue"));
    }
  }

  googleBtn.addEventListener("click", async () => {
    clearBoxes();
    setLoading(googleBtn, true, "Redirection…", "Continuer avec Google");

    const { error } = await sb.auth.signInWithOAuth({
      provider: "google",
      options: {
        redirectTo: REDIRECT_URL,
        // IMPORTANT: scopes calendar are handled by your separate Google Calendar OAuth flow.
        // Here it's only "Sign in with Google" for Supabase Auth.
      }
    });

    if (error) {
      setLoading(googleBtn, false, "", "Continuer avec Google");
      showErr("Erreur Google: " + (error.message || "inconnue"));
    }
  });

  magicBtn.addEventListener("click", async () => {
    clearBoxes();
    const email = (emailInput.value || "").trim().toLowerCase();

    if (!email) {
      showErr("Entre ton email.");
      return;
    }

    setLoading(magicBtn, true, "Envoi…", "M’envoyer le lien de connexion");

    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: REDIRECT_URL }
    });

    setLoading(magicBtn, false, "Envoi…", "M’envoyer le lien de connexion");

    if (error) {
      showErr("Erreur envoi email: " + (error.message || "inconnue"));
      return;
    }

    showOk("Lien envoyé. Ouvre ton email et clique sur le lien pour revenir ici.");
  });

  // Run on load (handles OAuth / magic link return)
  postLoginFlow();

  // Also listen to auth changes (just in case)
  sb.auth.onAuthStateChange((_event, _session) => {
    postLoginFlow();
  });
})();
</script>
</body>
</html>
